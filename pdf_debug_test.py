import requests
import sys
import json
import uuid
import base64
from datetime import datetime
from typing import Optional, Dict, Any
import time
import re

class PDFDebugTester:
    def __init__(self, base_url="https://realestate-finance-1.preview.emergentagent.com"):
        self.base_url = base_url
        self.tests_run = 0
        self.tests_passed = 0
        self.auth_token = None
        self.auth_cookies = None
        # Demo user credentials for testing
        self.demo_email = "demo@demo.com"
        self.demo_password = "Goosey23!!23"

    def run_test(self, name, method, endpoint, expected_status, data=None, headers=None, auth_required=False, cookies=None):
        """Run a single API test"""
        url = f"{self.base_url}/{endpoint}"
        default_headers = {'Content-Type': 'application/json'}
        
        # Use cookies if available and auth is required
        if auth_required and self.auth_cookies:
            cookies = self.auth_cookies
        elif auth_required and self.auth_token:
            default_headers['Authorization'] = f'Bearer {self.auth_token}'
        
        if headers:
            default_headers.update(headers)

        self.tests_run += 1
        print(f"\nüîç Testing {name}...")
        print(f"   URL: {url}")
        
        try:
            if method == 'GET':
                response = requests.get(url, headers=default_headers, cookies=cookies, timeout=15)
            elif method == 'POST':
                response = requests.post(url, json=data, headers=default_headers, cookies=cookies, timeout=15)
            elif method == 'PUT':
                response = requests.put(url, json=data, headers=default_headers, cookies=cookies, timeout=15)
            elif method == 'DELETE':
                response = requests.delete(url, json=data, headers=default_headers, cookies=cookies, timeout=15)

            success = response.status_code == expected_status
            if success:
                self.tests_passed += 1
                print(f"‚úÖ Passed - Status: {response.status_code}")
                try:
                    response_data = response.json()
                    print(f"   Response: {json.dumps(response_data, indent=2)[:300]}...")
                except:
                    print(f"   Response: {response.text[:300]}...")
            else:
                print(f"‚ùå Failed - Expected {expected_status}, got {response.status_code}")
                print(f"   Response: {response.text[:300]}...")

            return success, response.json() if response.headers.get('content-type', '').startswith('application/json') else response.text

        except requests.exceptions.Timeout:
            print(f"‚ùå Failed - Request timeout")
            return False, {}
        except requests.exceptions.ConnectionError:
            print(f"‚ùå Failed - Connection error")
            return False, {}
        except Exception as e:
            print(f"‚ùå Failed - Error: {str(e)}")
            return False, {}

    def test_pdf_generation_debug(self):
        """Debug PDF generation issue with test-pdf endpoint"""
        print("\nüîç TESTING PDF GENERATION DEBUG...")
        print("   Testing: POST /api/brand/test-pdf endpoint 500 error")
        print("   Expected: Identify specific error causing 500 response")
        print("   Context: Debug WeasyPrint dependencies and function availability")
        
        results = {}
        
        # 1. Test authentication first
        auth_success, auth_response = self.test_pdf_endpoint_authentication()
        results['authentication'] = {
            'success': auth_success,
            'response': auth_response
        }
        
        # 2. Test the endpoint with authentication
        endpoint_success, endpoint_response = self.test_pdf_endpoint_with_auth()
        results['endpoint_test'] = {
            'success': endpoint_success,
            'response': endpoint_response
        }
        
        # 3. Test WeasyPrint availability
        weasyprint_success, weasyprint_response = self.test_weasyprint_availability()
        results['weasyprint_check'] = {
            'success': weasyprint_success,
            'response': weasyprint_response
        }
        
        # 4. Test function imports
        import_success, import_response = self.test_function_imports()
        results['function_imports'] = {
            'success': import_success,
            'response': import_response
        }
        
        # Calculate overall success
        total_tests = 4
        successful_tests = sum([
            auth_success,
            endpoint_success,
            weasyprint_success,
            import_success
        ])
        
        overall_success = successful_tests >= 2  # Allow failures for debugging
        
        print(f"\nüîç PDF GENERATION DEBUG TESTING SUMMARY:")
        print(f"   ‚úÖ Successful tests: {successful_tests}/{total_tests}")
        print(f"   üìà Success rate: {(successful_tests/total_tests)*100:.1f}%")
        
        if overall_success:
            print("   üéâ PDF Generation Debug - ISSUES IDENTIFIED")
        else:
            print("   ‚ùå PDF Generation Debug - CRITICAL ISSUES FOUND")
            
        return overall_success, results
    
    def test_pdf_endpoint_authentication(self):
        """Test that PDF endpoint requires authentication"""
        print("\nüîê TESTING PDF ENDPOINT AUTHENTICATION...")
        
        try:
            # Test without authentication
            print("   üîç Testing without authentication...")
            response = requests.post(
                f"{self.base_url}/api/brand/test-pdf",
                timeout=15
            )
            
            if response.status_code == 401:
                print("   ‚úÖ PDF endpoint properly requires authentication (401)")
                return True, {"unauthenticated_blocked": True, "status": response.status_code}
            else:
                print(f"   ‚ùå PDF endpoint should require authentication, got {response.status_code}")
                return False, {"error": "Authentication not required", "status": response.status_code}
                
        except Exception as e:
            print(f"   ‚ùå Error testing PDF endpoint authentication: {e}")
            return False, {"error": str(e)}
    
    def test_pdf_endpoint_with_auth(self):
        """Test PDF endpoint with authentication to see exact error"""
        print("\nüìÑ TESTING PDF ENDPOINT WITH AUTHENTICATION...")
        
        try:
            import requests
            session = requests.Session()
            
            # Login first
            login_data = {
                "email": "demo@demo.com",
                "password": "Goosey23!!23",
                "remember_me": False
            }
            
            login_response = session.post(
                f"{self.base_url}/api/auth/login",
                json=login_data,
                timeout=15
            )
            
            if login_response.status_code != 200:
                print("   ‚ùå Could not login for PDF test")
                return False, {"error": "Login failed", "status": login_response.status_code}
            
            print("   ‚úÖ Login successful for PDF test")
            
            # Now test the PDF endpoint
            print("   üîç Testing POST /api/brand/test-pdf with authentication...")
            pdf_response = session.post(
                f"{self.base_url}/api/brand/test-pdf",
                timeout=30  # PDF generation might take longer
            )
            
            print(f"   üîç PDF endpoint response status: {pdf_response.status_code}")
            
            if pdf_response.status_code == 200:
                print("   ‚úÖ PDF endpoint successful")
                
                # Check if it's actually a PDF
                content_type = pdf_response.headers.get('content-type', '')
                if 'application/pdf' in content_type:
                    print("   ‚úÖ Response is a PDF file")
                    content_length = len(pdf_response.content)
                    print(f"   ‚úÖ PDF size: {content_length} bytes")
                    
                    return True, {
                        "pdf_generated": True,
                        "content_type": content_type,
                        "content_length": content_length
                    }
                else:
                    print(f"   ‚ö†Ô∏è  Response is not a PDF: {content_type}")
                    return False, {"error": "Not a PDF response", "content_type": content_type}
            
            elif pdf_response.status_code == 500:
                print("   ‚ùå PDF endpoint returned 500 Internal Server Error")
                try:
                    error_response = pdf_response.json()
                    error_detail = error_response.get('detail', 'Unknown error')
                    print(f"   ‚ùå Error detail: {error_detail}")
                    
                    # Check for specific errors
                    if 'weasyprint' in error_detail.lower():
                        print("   üö® CRITICAL: WeasyPrint related error detected")
                    elif 'html' in error_detail.lower():
                        print("   üö® CRITICAL: HTML related error detected")
                    elif 'import' in error_detail.lower():
                        print("   üö® CRITICAL: Import error detected")
                    elif 'not defined' in error_detail.lower():
                        print("   üö® CRITICAL: Function not defined error detected")
                    
                    return False, {
                        "error": "500 Internal Server Error",
                        "detail": error_detail,
                        "status": pdf_response.status_code
                    }
                except:
                    error_text = pdf_response.text[:500]
                    print(f"   ‚ùå Error response (text): {error_text}")
                    return False, {
                        "error": "500 Internal Server Error",
                        "response_text": error_text,
                        "status": pdf_response.status_code
                    }
            else:
                print(f"   ‚ùå PDF endpoint failed with status {pdf_response.status_code}")
                try:
                    error_response = pdf_response.json()
                    print(f"   ‚ùå Error: {error_response.get('detail', 'Unknown error')}")
                    return False, {"error": error_response.get('detail', 'Unknown error'), "status": pdf_response.status_code}
                except:
                    print(f"   ‚ùå Response: {pdf_response.text[:200]}")
                    return False, {"error": "PDF endpoint failed", "status": pdf_response.status_code}
                
        except Exception as e:
            print(f"   ‚ùå Error testing PDF endpoint: {e}")
            return False, {"error": str(e)}
    
    def test_weasyprint_availability(self):
        """Test WeasyPrint availability and dependencies"""
        print("\nüñ®Ô∏è  TESTING WEASYPRINT AVAILABILITY...")
        
        try:
            # Test if WeasyPrint can be imported
            print("   üîç Testing WeasyPrint import...")
            
            try:
                from weasyprint import HTML, CSS
                print("   ‚úÖ WeasyPrint import successful")
                weasyprint_available = True
            except ImportError as e:
                print(f"   ‚ùå WeasyPrint import failed: {e}")
                weasyprint_available = False
            except Exception as e:
                print(f"   ‚ùå WeasyPrint import error: {e}")
                weasyprint_available = False
            
            # Test basic WeasyPrint functionality if available
            if weasyprint_available:
                try:
                    print("   üîç Testing basic WeasyPrint functionality...")
                    test_html = "<html><body><h1>Test</h1></body></html>"
                    html_obj = HTML(string=test_html)
                    pdf_bytes = html_obj.write_pdf()
                    
                    if pdf_bytes and len(pdf_bytes) > 0:
                        print(f"   ‚úÖ WeasyPrint PDF generation working ({len(pdf_bytes)} bytes)")
                        return True, {
                            "weasyprint_available": True,
                            "basic_generation_working": True,
                            "test_pdf_size": len(pdf_bytes)
                        }
                    else:
                        print("   ‚ùå WeasyPrint PDF generation returned empty result")
                        return False, {
                            "weasyprint_available": True,
                            "basic_generation_working": False,
                            "error": "Empty PDF result"
                        }
                except Exception as e:
                    print(f"   ‚ùå WeasyPrint PDF generation failed: {e}")
                    return False, {
                        "weasyprint_available": True,
                        "basic_generation_working": False,
                        "error": str(e)
                    }
            else:
                return False, {
                    "weasyprint_available": False,
                    "error": "WeasyPrint not available"
                }
                
        except Exception as e:
            print(f"   ‚ùå Error testing WeasyPrint: {e}")
            return False, {"error": str(e)}
    
    def test_function_imports(self):
        """Test if required functions are available in the backend"""
        print("\nüîß TESTING FUNCTION IMPORTS...")
        
        # We can't directly test imports in the backend from here,
        # but we can test if the functions are working by checking the error messages
        print("   üîç Testing function availability through error analysis...")
        
        try:
            import requests
            session = requests.Session()
            
            # Login first
            login_data = {
                "email": "demo@demo.com",
                "password": "Goosey23!!23",
                "remember_me": False
            }
            
            login_response = session.post(
                f"{self.base_url}/api/auth/login",
                json=login_data,
                timeout=15
            )
            
            if login_response.status_code != 200:
                print("   ‚ùå Could not login for function test")
                return False, {"error": "Login failed"}
            
            # Test the PDF endpoint to get error details
            pdf_response = session.post(
                f"{self.base_url}/api/brand/test-pdf",
                timeout=15
            )
            
            if pdf_response.status_code == 500:
                try:
                    error_response = pdf_response.json()
                    error_detail = error_response.get('detail', '').lower()
                    
                    # Analyze the error for function availability
                    function_issues = {}
                    
                    if 'html is not defined' in error_detail:
                        print("   ‚ùå HTML function not defined - WeasyPrint import issue")
                        function_issues['html_function'] = False
                    else:
                        function_issues['html_function'] = True
                    
                    if 'generate_test_pdf_html' in error_detail:
                        print("   ‚ùå generate_test_pdf_html function issue")
                        function_issues['generate_test_pdf_html'] = False
                    else:
                        function_issues['generate_test_pdf_html'] = True
                    
                    if 'generate_pdf_with_weasyprint_from_html' in error_detail:
                        print("   ‚ùå generate_pdf_with_weasyprint_from_html function issue")
                        function_issues['generate_pdf_with_weasyprint'] = False
                    else:
                        function_issues['generate_pdf_with_weasyprint'] = True
                    
                    # Check for import errors
                    if 'import' in error_detail or 'module' in error_detail:
                        print("   ‚ùå Import error detected in backend")
                        function_issues['imports'] = False
                    else:
                        function_issues['imports'] = True
                    
                    # Overall assessment
                    working_functions = sum(function_issues.values())
                    total_functions = len(function_issues)
                    
                    if working_functions == total_functions:
                        print("   ‚úÖ All functions appear to be available")
                        return True, function_issues
                    else:
                        print(f"   ‚ùå Function issues detected ({working_functions}/{total_functions} working)")
                        return False, function_issues
                        
                except:
                    print("   ‚ùå Could not parse error response for function analysis")
                    return False, {"error": "Could not analyze error response"}
            
            elif pdf_response.status_code == 200:
                print("   ‚úÖ All functions working - PDF generated successfully")
                return True, {"all_functions_working": True}
            
            else:
                print(f"   ‚ö†Ô∏è  Unexpected response status: {pdf_response.status_code}")
                return False, {"error": f"Unexpected status: {pdf_response.status_code}"}
                
        except Exception as e:
            print(f"   ‚ùå Error testing function imports: {e}")
            return False, {"error": str(e)}

def run_pdf_debug_tests():
    """Run PDF generation debug tests"""
    print("üéØ PDF GENERATION DEBUG TESTING")
    print("="*80)
    print("Testing: POST /api/brand/test-pdf endpoint 500 error")
    print("Context: Debug WeasyPrint dependencies and function availability")
    print("Expected: Identify specific error causing 500 response")
    print("="*80)
    
    tester = PDFDebugTester()
    
    # Run the PDF debug test
    print("\n" + "="*80)
    success, results = tester.test_pdf_generation_debug()
    print("="*80)
    
    print(f"\nüìä PDF GENERATION DEBUG TEST RESULTS:")
    print(f"   Overall Status: {'‚úÖ ISSUES IDENTIFIED' if success else '‚ùå CRITICAL ISSUES'}")
    
    # Detailed results breakdown
    if 'authentication' in results:
        auth_result = results['authentication']
        print(f"   Authentication: {'‚úÖ PASSED' if auth_result['success'] else '‚ùå FAILED'}")
    
    if 'endpoint_test' in results:
        endpoint_result = results['endpoint_test']
        print(f"   Endpoint Test: {'‚úÖ PASSED' if endpoint_result['success'] else '‚ùå FAILED'}")
        if not endpoint_result['success']:
            error_detail = endpoint_result['response'].get('detail', 'Unknown error')
            print(f"      Error: {error_detail}")
            
            # Identify specific issues
            if 'HTML is not defined' in error_detail:
                print("      üö® CRITICAL: WeasyPrint HTML not imported")
            elif 'weasyprint' in error_detail.lower():
                print("      üö® CRITICAL: WeasyPrint dependency issue")
            elif 'generate_test_pdf_html' in error_detail:
                print("      üö® CRITICAL: generate_test_pdf_html function missing")
            elif 'generate_pdf_with_weasyprint_from_html' in error_detail:
                print("      üö® CRITICAL: generate_pdf_with_weasyprint_from_html function missing")
    
    if 'weasyprint_check' in results:
        weasyprint_result = results['weasyprint_check']
        print(f"   WeasyPrint Check: {'‚úÖ PASSED' if weasyprint_result['success'] else '‚ùå FAILED'}")
        if not weasyprint_result['success']:
            print(f"      Error: {weasyprint_result['response'].get('error', 'Unknown')}")
    
    if 'function_imports' in results:
        import_result = results['function_imports']
        print(f"   Function Imports: {'‚úÖ PASSED' if import_result['success'] else '‚ùå FAILED'}")
    
    # Calculate success rate
    total_tests = len(results)
    passed_tests = sum(1 for result in results.values() if result['success'])
    success_rate = (passed_tests / total_tests * 100) if total_tests > 0 else 0
    
    print(f"\nüìà Success Rate: {success_rate:.1f}% ({passed_tests}/{total_tests})")
    
    # Provide specific recommendations
    print(f"\nüîç ROOT CAUSE ANALYSIS:")
    
    if 'endpoint_test' in results and not results['endpoint_test']['success']:
        error_detail = results['endpoint_test']['response'].get('detail', '')
        
        if 'HTML is not defined' in error_detail:
            print("   üö® ISSUE IDENTIFIED: WeasyPrint HTML class not imported")
            print("   üí° SOLUTION: Uncomment 'from weasyprint import HTML, CSS' in server.py line 31")
            print("   üí° ALTERNATIVE: Install WeasyPrint dependencies if missing")
        
        elif 'weasyprint' in error_detail.lower():
            print("   üö® ISSUE IDENTIFIED: WeasyPrint dependency problem")
            print("   üí° SOLUTION: Install WeasyPrint and its dependencies")
            print("   üí° COMMAND: pip install weasyprint")
        
        elif 'generate_' in error_detail:
            print("   üö® ISSUE IDENTIFIED: PDF generation function missing or broken")
            print("   üí° SOLUTION: Check function definitions in server.py")
        
        else:
            print(f"   üö® UNKNOWN ISSUE: {error_detail}")
            print("   üí° SOLUTION: Check backend logs for more details")
    
    if success:
        print("\nüéâ PDF GENERATION DEBUG - ROOT CAUSE IDENTIFIED")
        print("   ‚úÖ Issue analysis completed")
        print("   ‚úÖ Specific error details captured")
        print("   ‚úÖ Solution recommendations provided")
    else:
        print("\n‚ùå PDF GENERATION DEBUG - CRITICAL ISSUES FOUND")
        print("   ‚ùå Multiple system failures detected")
        print("   ‚ùå Requires immediate attention")
    
    return success

if __name__ == "__main__":
    success = run_pdf_debug_tests()
    sys.exit(0 if success else 1)